<!DOCTYPE html>
<html>
  <head>
    <title>node.js - the good, the bad and the ugly</title>
    <link type='text/css' rel='stylesheet' href='css/main.css'>
    <link rel='stylesheet' href='css/theme/default.css' id='theme'>
    <link rel='stylesheet' href='hl/styles/github.css'>
    <style>
    .smallish
    {
      font-size: 75%;
    }
    .small
    {
      font-size: 50%;
    }
    .warn
    {
      font-weight: bold;
      color: red;
    }
    .good
    {
      color: green;
    }
    .bad
    {
      color: red;
    }
    .term
    {
      padding: 10px;
      background-color: #000;
      color: #fff;
    }
    .green
    {
      color: green;
    }
    .purple
    {
      color: purple;
    }
    </style>
  </head>
  <body>
    <div class='reveal'>
      <div class='slides'>
        <section>
          <h1>node.js</h1>
          <hr>
          <h3>bringing event-driven programming to the masses since 2009</h3>
          <span class='small'>
            by Ben Noordhuis<br>
            <a href='mailto:info@bnoordhuis.nl'>info@bnoordhuis.nl</a><br>
            <a href='https://github.com/bnoordhuis'>
              https://github.com/bnoordhuis
            </a>
          </span>
        </section>

        <section>
          <h2>about me</h2>
          <div class='small'>a.k.a. 'who is that guy?'</div>
          <ul>
            <li>contributor since early 2010</li>
            <li>committer since 2011</li>
            <li>
              employed by Cloud9<br>
              <img src='img/cloud9.png'>
            </li>
          </ul>
        </section>

        <section>
          <h2>a brief history of node.js</h2>
          <ul>
            <li class='fragment'>
              created by Ryan Dahl<br>
              <div class='small'>
                <a href='https://github.com/ry'>https://github.com/ry</a>
                <a href='https://twitter.com/ryah'>https://twitter.com/ryah</a>
                <br>
                <img src='img/ryan_dahl.jpg' style='padding:0;margin:0'>
                &larr; he's nicer than he looks
              </div>
            </li>

            <li class='fragment'>
              v0.0.1 released in May 2009<br>
              <div class='small'>(we're at v0.9.3 now)</div>
            </li>

            <li class='fragment'>
              smash hit at JSConf 2009<br>
              <span class='small'>
                <a href='http://jsconf.eu/2009/video_nodejs_by_ryan_dahl.html'>
                  http://jsconf.eu/2009/video_nodejs_by_ryan_dahl.html
                </a>
              </span>
            </li>

            <li class='fragment'>
              technology of the year 2012 according to InfoWorld<br>
              <span class='small'>
                <a href='http://joyent.com/company/press/node-js-selected-by-infoworld-for-2012-technology-of-the-year-award'>
                  http://joyent.com/company/press/node-js-selected-by-infoworld-for-2012-technology-of-the-year-award
                </a>
              </span>
            </li>
          </ul>
        </section>

        <section>
          <h2>who uses node.js?</h2>
          <table border='0' style='
              margin-left:120px;
              background-color:rgb(51,52,45)'>
            <tr>
              <td style='padding-left:50px; padding-right:30px;'>
                <img style='border:0' src='img/users/ebay.png'><br>
                <img style='border:0' src='img/users/iriscouch.png'><br>
                <img style='border:0' src='img/users/linkedin.png'><br>
              </td>
              <td style='padding-left:30px; padding-right:50px;'>
                <img style='border:0' src='img/users/microsoft.png'><br>
                <img style='border:0' src='img/users/voxer.png'><br>
                <img style='border:0' src='img/users/yahoo.png'><br>
              </td>
            </tr>
            <tr>
              <td style='padding-left:200px'>
                <img style='border:0' src='img/users/cloud9.png'>
              </td>
            </tr>
          </table>
          <div class='small'>
            <a href='https://github.com/joyent/node/wiki/Projects%2C-Applications%2C-and-Companies-Using-Node'>
              https://github.com/joyent/node/wiki/Projects,-Applications,-and-Companies-Using-Node
            </a>
          </div>
        </section>

        <section>
          <img src='img/node-old.png' style='padding:0;margin:0'>
          <div class='smallish'>pre-0.6 architecture</div>
        </section>

        <section>
          <img src='img/node-new.png' style='padding:0;margin:0'>
          <div class='smallish'>current architecture</div>
        </section>

        <section>
          <pre><code class='lang-c'>
int fds[LARGE_NUMBER];

// ...

fd_set readfds;
fd_set writefds;

for (;;) {
  FD_ZERO(&readfds);
  FD_ZERO(&writefds);

  for (int i = 0; i < nfds; i++) {
    FD_SET(fds[i], &readfds);
    FD_SET(fds[i], &writefds);
  }

  n = select(nfds + 1, &readfds, &writefds, NULL, NULL);
  if (n == -1) {
    if (errno == EINTR) continue;
    return -1;
  }

  for (int i = 0; i < nfds && n > 0; i++) {
    if (FD_ISSET(fds[i], &readfds)) do_read(fds[i]), n--;
    if (FD_ISSET(fds[i], &writefds)) do_write(fds[i]), n--;
  }
}
          </code></pre>
        </section>

        <section>
          <h2>so what is node.js?</h2>
          <div class='small'>(enumeration first, details follow)</div>
          <ul>
            <li>server-side javascript</li>
            <li>non-blocking I/O</li>
            <li>small core, rich module ecosystem</li>
            <li>like eventmachine, only <u>everything</u> is async</li>
          </ul>
          <br>
          <br>
          <div class='smallish' style='margin-left:300px;width:300px;'>
            <pre>
what        | lines of code
===========================
v8          |       663,742
openssl     |       273,521
libuv       |        43,833
c-ares      |        21,092
node (js)   |        19,051
node (c++)  |        18,209
            </pre>
          </div>
        </section>

        <section>
          <h2>server-side javascript</h2>
          <ul>
            <li>
              one language to rule them all
              <span class='small'>(where all == server and client)</span>
            </li>
            <li class='fragment'>
              not really comparable with
              <a href='http://en.wikipedia.org/wiki/Netscape_Enterprise_Server'>
                Netscape Enterprise Server
              </a>
              or
              <a href='http://en.wikipedia.org/wiki/JScript'>
                MS JScript
              </a>
              because of...
          </ul>
        </section>

        <section>
          <h1>non-blocking I/O</h1>
          <h3 class='fragment'>but first: blocking I/O</h3>
        </section>

        <section>
          <h2>blocking I/O</h2>
          <pre><code class='language-javascript'>
// make 100 requests to google.com
for (var i = 0; i < 100; ++i) {
  var conn = net.connect({ host: 'google.com', port: 80 });
  conn.write('GET / HTTP/0.9\r\n');
  var data = conn.read();
  conn.destroy();
  console.log(data);
}
          </code></pre>
          <div class='small warn'>pseudocode warning</div>
          <ul>
            <li><span class='good'>pro:</span> simple, readable</li>
            <li>
              <span class='bad'>con:</span> inherently slow, never
              faster than <strong>100 * min_request_time</strong>
            </li>
          </ul>
        </section>

        <section>
          <h2>blocking I/O, pre-fork</h2>
          <pre><code class='language-javascript'>
// make 100 requests to google.com
for (var i = 0; i < 100; ++i) {
  // spawn a new process
  if (fork() == 0) {
    var conn = net.connect({ host: 'google.com', port: 80 });
    conn.write('GET / HTTP/0.9\r\n');
    var data = conn.read();
    conn.destroy();
    console.log(data);
  }
}
          </code></pre>
          <div class='small warn'>pseudocode warning</div>
          <ul>
            <li>
              <span class='good'>pro:</span>
              still pretty simple and readable
            </li>
            <li>
              <span class='good'>pro:</span>
              fast, runs in <strong>max_request_time</strong>
              <span class='small'>(plus OS overhead)</span>
            </li>
            <li>
            <span class='bad'>con:</span>
              OS processes aren't cheap
              <span class='small'>(ditto for threads)</span>
            </li>
            <li>still, not entirely without merit</li>
          </ul>
        </section>

        <section>
          <h2>non-blocking I/O</h2>
          <pre><code class='language-javascript'>
// make 100 requests to google.com
for (var i = 0; i < 100; ++i) {
  net.connect({ host: 'google.com', port: 80 }, function() {
    var conn = this;
    conn.write('GET / HTTP/0.9\r\n', function() {
      conn.read(function(data) {
        console.log(data);
        conn.destroy();
      });
    });
  });
}
          </code></pre>
          <ul>
            <li>
              <span class='good'>pro:</span>
              fast, finishes in <strong>max_request_time</strong>
            </li>
            <li>
              <span class='bad'>con:</span> lots of callbacks
            </li>
          </ul>
        </section>

        <section>
          <h2>non-blocking I/O with streams</h2>
          <pre><code class='language-javascript'>
// make 100 requests to google.com
for (var i = 0; i < 100; ++i) {
  net.connect({ host: 'google.com', port: 80 }, function() {
    var conn = this;
    conn.write('GET / HTTP/0.9\r\n');
    conn.pipe(process.stdout);
  });
}
          </code></pre>
          <br>
          quite readable, right?
        </section>

        <section>
          <h2>small core, rich module ecosystem</h2>
          <ul>
            <li class='fragment'>no batteries included</li>
            <li class='fragment'>huge core hampers progress (cf. Python)</li>
            <li class='fragment'>
              less maintenance, means I can go home at four :-)
            </li>
          </ul>
        </section>

        <section>
          <h3>an example module: my first chat app</h3>
          <a href='https://github.com/bnoordhuis/chat-example'>
            https://github.com/bnoordhuis/chat-example
          </a>
          <pre class='term'>
$ git clone git://github.com/bnoordhuis/chat-example.git
$ cd chat-example
$ node run.js
          </pre>
        </section>

        <section>
          <h2>create the module</h2>
          <pre class='term'>
$ npm init
name: (chat) chat-example
version: (0.0.0) 0.0.1
description: my first chat app
entry point: (index.js) 
test command: echo "Real Programmers don't need tests"
git repository: git://github.com/bnoordhuis/chat-example.git
keywords: chat chat chat
author: Ben Noordhuis
license: (BSD) ISC
          </pre>
        </section>

        <section>
          package.json
          <pre><code class='language-javascript'>
{
  "name": "chat-example",
  "version": "0.0.1",
  "description": "my first chat app",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Real Programmers don't need tests\""
  },
  "repository": {
    "type": "git",
    "url": "git://github.com/bnoordhuis/chat-example.git"
  },
  "keywords": [
    "chat",
    "chat",
    "chat"
  ],
  "author": "Ben Noordhuis",
  "license": "ISC"
}</code></pre>
        </section>

        <section>
          index.js
          <pre><code class='language-javascript'>
exports.start = start;
exports.broadcast = broadcast;

var net = require('net');
var os = require('os');
var connections = [];

function start(port) {
  net.createServer(port, on_connection).listen(port);
  var address = os.networkInterfaces()['wlan0'][0].address;
  console.log('Connect with: netcat %s %d', address, port);
}

function broadcast(msg, skip) {
  connections.forEach(function(conn) {
    if (conn !== skip) conn.write(msg);
  });
  process.stdout.write(msg);
}
          </code></pre>
        </section>

        <section>
          <pre><code class='language-javascript'>
function on_connection(conn) {
  conn.id = conn.remoteAddress + ':' + conn.remotePort;
  broadcast(conn.id + ' joined\n');
  connections.push(conn);
  conn.on('data', on_client_data)
  conn.on('close', on_client_exit);
  conn.on('error', on_client_exit);
}

function on_client_data(data) {
  var conn = this;
  broadcast(conn.id + ' says: ' + data, conn);
}

function on_client_exit(err) {
  var conn = this;
  if (err) console.error(conn.id + ' died: ' + err.message);
  connections.splice(connections.indexOf(conn)); // remove from list
  broadcast(conn.id + ' left\n');
}
          </code></pre>
        </section>

        <section>
          <pre class='term'>
$ npm publish
npm <span class='green'>http</span> <span class='purple'>PUT</span> https://registry.npmjs.org/chat-example
npm <span class='green'>http</span> <span class='purple'>201</span> https://registry.npmjs.org/chat-example
npm <span class='green'>http</span> <span class='purple'>GET</span> https://registry.npmjs.org/chat-example
npm <span class='green'>http</span> <span class='purple'>200</span> https://registry.npmjs.org/chat-example
npm <span class='green'>http</span> <span class='purple'>PUT</span> https://registry.npmjs.org/chat-example/0.0.1/-tag/latest
npm <span class='green'>http</span> <span class='purple'>201</span> https://registry.npmjs.org/chat-example/0.0.1/-tag/latest
npm <span class='green'>http</span> <span class='purple'>GET</span> https://registry.npmjs.org/chat-example
npm <span class='green'>http</span> <span class='purple'>200</span> https://registry.npmjs.org/chat-example
npm <span class='green'>http</span> <span class='purple'>PUT</span> https://registry.npmjs.org/chat-example/-/chat-example-0.0.1.tgz/-rev/2-68c8a3423827c586277c05311f9b7fb8
npm <span class='green'>http</span> <span class='purple'>201</span> https://registry.npmjs.org/chat-example/-/chat-example-0.0.1.tgz/-rev/2-68c8a3423827c586277c05311f9b7fb8
+ chat-example@0.0.1
          </pre>
        </section>

        <section>
          <h2>how to use our module?</h2>
          <pre class='term'>
$ git checkout -b usage-example -t origin/usage-example
          </pre>
        </section>

        <section>
          package.json
          <pre><code class='language-javascript'>
{
  "name": "usage-example",
  "version": "0.0.1",
  "description": "how to use my first chat app",
  "main": "run.js",
  "author": "Ben Noordhuis",
  "license": "ISC",
  "dependencies": {
    "chat-example": "0.0.1"
  }
}
          </code></pre>
        </section>

        <section>
          run.js
          <pre><code class='language-javascript'>
var chat = require('chat-example');
chat.start(8000);
          </code></pre>
        </section>

        <section>
          <pre class='term'>
$ npm update
npm <span class='green'>http</span> <span class='purple'>GET</span> https://registry.npmjs.org/chat-example/0.0.1
npm <span class='green'>http</span> <span class='purple'>200</span> https://registry.npmjs.org/chat-example/0.0.1
npm <span class='green'>http</span> <span class='purple'>GET</span> https://registry.npmjs.org/chat-example/-/chat-example-0.0.1.tgz
npm <span class='green'>http</span> <span class='purple'>200</span> https://registry.npmjs.org/chat-example/-/chat-example-0.0.1.tgz
npm <span class='green'>http</span> <span class='purple'>GET</span> https://registry.npmjs.org/chat-example/0.0.1
npm <span class='green'>http</span> <span class='purple'>304</span> https://registry.npmjs.org/chat-example/0.0.1
chat-example@0.0.1 node_modules/chat-example

$ ls -l node_modules/
drwxrwxr-x 2 bnoordhuis bnoordhuis 4096 Oct  4 00:03 chat-example

$ node run.js
Connect with: netcat 192.168.1.6 8000
          </pre>
        </section>

        <section>
          <h1>Try it</h1>
        </section>

        <section>
          <h1>Questions?</h1>
        </section>
      </div>
    </div>

    <aside class='controls'>
      <a class='left' href='#'>&#x25C4;</a>
      <a class='right' href='#'>&#x25ba;</a>
      <a class='up' href='#'>&#x25b2;</a>
      <a class='down' href='#'>&#x25bc;</a>
    </aside>

  </body>
  <script src='lib/js/head.min.js'></script>
  <script src='js/reveal.min.js'></script>
  <script src='hl/highlight.pack.js'></script>
  <script>
    hljs.initHighlighting();
    Reveal.initialize({ theme: 'beige', transition: 'linear' });
  </script>
</html>
